



<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <link rel="stylesheet" href="../mdzdoc-css/main.css" type="text/css" charset="utf-8">
    <title>Key Exchange</title>
    <meta name="description" content="">
  </head>
  <body>
    <!-- Toggles Navigation -->
    <div id="toc-toggle" class="">
      <div class="bar topbar"></div>
      <div class="bar"></div>
      <div class="bar botbar"></div>
    </div>
    <div class="twocol">
      <div class="toc toc-hidden">
        <ul>
          <li><span><a href="../index.html">Jhydro</a></span></li><li class="caret"><span><a href="index.html">API</a></span><ul><li><span><a href="hash.html">General Purpose Hashing</a></span></li><li><span><a href="kdf.html">Key Derivation</a></span></li><li><span class="selected"><a href="kx.html">Key Exchange</a></span></li><li><span><a href="pwhash.html">Password Hashing</a></span></li><li><span><a href="sign.html">Public Key Signing</a></span></li><li><span><a href="random.html">Random Number Generation</a></span></li><li><span><a href="secretbox.html">Symmetric Encryption</a></span></li><li><span><a href="util.html">Utilities</a></span></li></ul></li>
        </ul>
      </div>
      <div class="content-wrapper">
        <h1>Key Exchange</h1>
        <div class="prevnext-bar">
          <span class="prev"><a href="kdf.html"><span class="prevnext-text">Key Derivation</span></a></span>
          <span class="next"><a href="pwhash.html"><span class="prevnext-text">Password Hashing</span></a></span>
        </div>
        

<p>Jhydro comes with three variants of key exchanges. The N variant, the KK variant, and
the XX variant. For more information on their use in libhydrogen, see
<a href="https://github.com/jedisct1/libhydrogen/wiki/Key-exchange">the wiki</a>. All variants
exchange a pair of symmetric keys, so that client A can send encrypted messages to client B, and 
B can send encrypted messages to A.
</p>
<h3>Usage Examples
</h3>
<h4>N variant
</h4>
<pre class="mendoza-codeblock"><code data-language="janet">(<span class="mdzsyn-coresym">use</span> <span class="mdzsyn-symbol">jhydro</span>)

(<span class="mdzsyn-coresym">def</span> {<span class="mdzsyn-keyword">:public-key</span> <span class="mdzsyn-symbol">pk</span> <span class="mdzsyn-keyword">:secret-key</span> <span class="mdzsyn-symbol">sk</span>} (<span class="mdzsyn-symbol">kx/keygen</span>))
(<span class="mdzsyn-coresym">def</span> <span class="mdzsyn-symbol">packet</span> <span class="mdzsyn-string">@""</span>)
(<span class="mdzsyn-coresym">def</span> <span class="mdzsyn-symbol">psk</span> (<span class="mdzsyn-symbol">random/buf</span> <span class="mdzsyn-symbol">kx/psk-bytes</span>))
(<span class="mdzsyn-coresym">def</span> {<span class="mdzsyn-keyword">:tx</span> <span class="mdzsyn-symbol">client-tx</span> <span class="mdzsyn-keyword">:rx</span> <span class="mdzsyn-symbol">client-rx</span>} (<span class="mdzsyn-symbol">kx/n1</span> <span class="mdzsyn-symbol">packet</span> <span class="mdzsyn-symbol">psk</span> <span class="mdzsyn-symbol">pk</span>))
(<span class="mdzsyn-coresym">def</span> {<span class="mdzsyn-keyword">:tx</span> <span class="mdzsyn-symbol">server-tx</span> <span class="mdzsyn-keyword">:rx</span> <span class="mdzsyn-symbol">server-rx</span>} (<span class="mdzsyn-symbol">kx/n2</span> <span class="mdzsyn-symbol">packet</span> <span class="mdzsyn-symbol">psk</span> <span class="mdzsyn-symbol">pk</span> <span class="mdzsyn-symbol">sk</span>))
<span class="mdzsyn-comment"># (test "client tx = server rx" (util/= client-tx server-rx))</span>
<span class="mdzsyn-comment"># (test "client rx = server tx" (util/= client-rx server-tx))</span></code></pre><h4>KK variant
</h4>
<pre class="mendoza-codeblock"><code data-language="janet">(<span class="mdzsyn-coresym">use</span> <span class="mdzsyn-symbol">jhydro</span>)

(<span class="mdzsyn-coresym">def</span> {<span class="mdzsyn-keyword">:public-key</span> <span class="mdzsyn-symbol">pk1</span> <span class="mdzsyn-keyword">:secret-key</span> <span class="mdzsyn-symbol">sk1</span>} (<span class="mdzsyn-symbol">kx/keygen</span>))
(<span class="mdzsyn-coresym">def</span> {<span class="mdzsyn-keyword">:public-key</span> <span class="mdzsyn-symbol">pk2</span> <span class="mdzsyn-keyword">:secret-key</span> <span class="mdzsyn-symbol">sk2</span>} (<span class="mdzsyn-symbol">kx/keygen</span>))
(<span class="mdzsyn-coresym">def</span> <span class="mdzsyn-symbol">packet1</span> <span class="mdzsyn-string">@""</span>)
(<span class="mdzsyn-coresym">def</span> <span class="mdzsyn-symbol">packet2</span> <span class="mdzsyn-string">@""</span>)
(<span class="mdzsyn-coresym">def</span> <span class="mdzsyn-symbol">a-state</span> (<span class="mdzsyn-symbol">kx/kk1</span> <span class="mdzsyn-symbol">packet1</span> <span class="mdzsyn-symbol">pk2</span> <span class="mdzsyn-symbol">pk1</span> <span class="mdzsyn-symbol">sk1</span>))
(<span class="mdzsyn-coresym">def</span> {<span class="mdzsyn-keyword">:tx</span> <span class="mdzsyn-symbol">b-tx</span> <span class="mdzsyn-keyword">:rx</span> <span class="mdzsyn-symbol">b-rx</span>} (<span class="mdzsyn-symbol">kx/kk2</span> <span class="mdzsyn-symbol">packet2</span> <span class="mdzsyn-symbol">packet1</span> <span class="mdzsyn-symbol">pk1</span> <span class="mdzsyn-symbol">pk2</span> <span class="mdzsyn-symbol">sk2</span>))
(<span class="mdzsyn-coresym">def</span> {<span class="mdzsyn-keyword">:tx</span> <span class="mdzsyn-symbol">a-tx</span> <span class="mdzsyn-keyword">:rx</span> <span class="mdzsyn-symbol">a-rx</span>} (<span class="mdzsyn-symbol">kx/kk3</span> <span class="mdzsyn-symbol">a-state</span> <span class="mdzsyn-symbol">packet2</span> <span class="mdzsyn-symbol">pk1</span> <span class="mdzsyn-symbol">sk1</span>))
<span class="mdzsyn-comment"># (test "a tx = b rx" (util/= a-tx b-rx))</span>
<span class="mdzsyn-comment"># (test "a rx = b tx" (util/= a-rx b-tx))</span></code></pre><h4>XX variant
</h4>
<pre class="mendoza-codeblock"><code data-language="janet">(<span class="mdzsyn-coresym">use</span> <span class="mdzsyn-symbol">jhydro</span>)

(<span class="mdzsyn-coresym">def</span> {<span class="mdzsyn-keyword">:public-key</span> <span class="mdzsyn-symbol">pk1</span> <span class="mdzsyn-keyword">:secret-key</span> <span class="mdzsyn-symbol">sk1</span>} (<span class="mdzsyn-symbol">kx/keygen</span>))
(<span class="mdzsyn-coresym">def</span> {<span class="mdzsyn-keyword">:public-key</span> <span class="mdzsyn-symbol">pk2</span> <span class="mdzsyn-keyword">:secret-key</span> <span class="mdzsyn-symbol">sk2</span>} (<span class="mdzsyn-symbol">kx/keygen</span>))
(<span class="mdzsyn-coresym">def</span> <span class="mdzsyn-symbol">packet1</span> <span class="mdzsyn-string">@""</span>)
(<span class="mdzsyn-coresym">def</span> <span class="mdzsyn-symbol">packet2</span> <span class="mdzsyn-string">@""</span>)
(<span class="mdzsyn-coresym">def</span> <span class="mdzsyn-symbol">packet3</span> <span class="mdzsyn-string">@""</span>)
(<span class="mdzsyn-coresym">def</span> <span class="mdzsyn-symbol">psk</span> (<span class="mdzsyn-symbol">random/buf</span> <span class="mdzsyn-symbol">kx/psk-bytes</span>))
(<span class="mdzsyn-coresym">def</span> <span class="mdzsyn-symbol">a-state</span> (<span class="mdzsyn-symbol">kx/xx1</span> <span class="mdzsyn-symbol">packet1</span> <span class="mdzsyn-symbol">psk</span>))
(<span class="mdzsyn-coresym">def</span> <span class="mdzsyn-symbol">b-state</span> (<span class="mdzsyn-symbol">kx/xx2</span> <span class="mdzsyn-symbol">packet2</span> <span class="mdzsyn-symbol">packet1</span> <span class="mdzsyn-symbol">psk</span> <span class="mdzsyn-symbol">pk2</span> <span class="mdzsyn-symbol">sk2</span>))
(<span class="mdzsyn-coresym">def</span> {<span class="mdzsyn-keyword">:tx</span> <span class="mdzsyn-symbol">b-tx</span> <span class="mdzsyn-keyword">:rx</span> <span class="mdzsyn-symbol">b-rx</span>} (<span class="mdzsyn-symbol">kx/xx3</span> <span class="mdzsyn-symbol">a-state</span> <span class="mdzsyn-symbol">packet3</span> <span class="mdzsyn-symbol">packet2</span> <span class="mdzsyn-symbol">psk</span> <span class="mdzsyn-symbol">pk1</span> <span class="mdzsyn-symbol">sk1</span>))
(<span class="mdzsyn-coresym">def</span> {<span class="mdzsyn-keyword">:tx</span> <span class="mdzsyn-symbol">a-tx</span> <span class="mdzsyn-keyword">:rx</span> <span class="mdzsyn-symbol">a-rx</span>} (<span class="mdzsyn-symbol">kx/xx4</span> <span class="mdzsyn-symbol">b-state</span> <span class="mdzsyn-symbol">packet3</span> <span class="mdzsyn-symbol">psk</span>))
<span class="mdzsyn-comment"># (test "a tx = b rx" (util/= a-tx b-rx))</span>
<span class="mdzsyn-comment"># (test "a rx = b tx" (util/= a-rx b-tx))</span></code></pre><h2>Index
</h2>
<p><a href="#kx/keygen">kx/keygen</a><span class="divider"> </span><a href="#kx/kk-packet-1-bytes">kx/kk-packet-1-bytes</a><span class="divider"> </span><a href="#kx/kk-packet-2-bytes">kx/kk-packet-2-bytes</a><span class="divider"> </span><a href="#kx/kk1">kx/kk1</a><span class="divider"> </span><a href="#kx/kk2">kx/kk2</a><span class="divider"> </span><a href="#kx/kk3">kx/kk3</a><span class="divider"> </span><a href="#kx/n-packet-1-bytes">kx/n-packet-1-bytes</a><span class="divider"> </span><a href="#kx/n1">kx/n1</a><span class="divider"> </span><a href="#kx/n2">kx/n2</a><span class="divider"> </span><a href="#kx/psk-bytes">kx/psk-bytes</a><span class="divider"> </span><a href="#kx/public-key-bytes">kx/public-key-bytes</a><span class="divider"> </span><a href="#kx/secret-key-bytes">kx/secret-key-bytes</a><span class="divider"> </span><a href="#kx/session-key-bytes">kx/session-key-bytes</a><span class="divider"> </span><a href="#kx/xx-packet-1-bytes">kx/xx-packet-1-bytes</a><span class="divider"> </span><a href="#kx/xx-packet-2-bytes">kx/xx-packet-2-bytes</a><span class="divider"> </span><a href="#kx/xx-packet-3-bytes">kx/xx-packet-3-bytes</a><span class="divider"> </span><a href="#kx/xx1">kx/xx1</a><span class="divider"> </span><a href="#kx/xx2">kx/xx2</a><span class="divider"> </span><a href="#kx/xx3">kx/xx3</a><span class="divider"> </span><a href="#kx/xx4">kx/xx4</a></p><h2>Reference
</h2>
<div class="docstring"><div class="binding-wrap"><span class="binding"><a id="kx/keygen">kx/keygen</a></span><span class="binding-type">cfunction</span></div><pre class="mendoza-codeblock"><code data-language="janet">(<span class="mdzsyn-symbol">kx/keygen</span>)</code></pre><p>Generate a keypair for use key exchanges. Contains both a public key and a secret key. Returns a struct with two entries, and :secret-key and a :public-key.</p></div><div class="docstring"><div class="binding-wrap"><span class="binding"><a id="kx/kk-packet-1-bytes">kx/kk-packet-1-bytes</a></span><span class="binding-type">number <code class="binding-realval">32</code></span></div><p>Number of bytes in the first packet sent in the KK variant key exchange.</p></div><div class="docstring"><div class="binding-wrap"><span class="binding"><a id="kx/kk-packet-2-bytes">kx/kk-packet-2-bytes</a></span><span class="binding-type">number <code class="binding-realval">32</code></span></div><p>Number of bytes in the second packet sent in the KK variant key exchange.</p></div><div class="docstring"><div class="binding-wrap"><span class="binding"><a id="kx/kk1">kx/kk1</a></span><span class="binding-type">cfunction</span></div><pre class="mendoza-codeblock"><code data-language="janet">(<span class="mdzsyn-symbol">kx/kk1</span> <span class="mdzsyn-symbol">packet-1</span> <span class="mdzsyn-symbol">static-pk</span> <span class="mdzsyn-symbol">pk</span> <span class="mdzsyn-symbol">sk</span>)</code></pre><p>Generate the first packet for the KK variant key exchange. Returns a jhydro/ks-state abstract which contains some useful state for the key exchange. static-pk is the peer's public key, and pk and sk are the client's public and secret keys. Modifies the buffer packet-1 by appending new data.</p></div><div class="docstring"><div class="binding-wrap"><span class="binding"><a id="kx/kk2">kx/kk2</a></span><span class="binding-type">cfunction</span></div><pre class="mendoza-codeblock"><code data-language="janet">(<span class="mdzsyn-symbol">kx/kk2</span> <span class="mdzsyn-symbol">packet-2</span> <span class="mdzsyn-symbol">packet-1</span> <span class="mdzsyn-symbol">static-pk</span> <span class="mdzsyn-symbol">pk</span> <span class="mdzsyn-symbol">sk</span>)</code></pre><p>Generate the second packet and a session keypair in the KK variant key exchange. packet-2 is a buffer to put the new packet in. packet-1 is the packet received from the peer. static-pk is the other peer's public key, and pk and sk are the local client's public and secret keys. Returns a session keypair, which is a struct of two entries, :rx and :tx.</p></div><div class="docstring"><div class="binding-wrap"><span class="binding"><a id="kx/kk3">kx/kk3</a></span><span class="binding-type">cfunction</span></div><pre class="mendoza-codeblock"><code data-language="janet">(<span class="mdzsyn-symbol">kx/kk3</span> <span class="mdzsyn-symbol">state</span> <span class="mdzsyn-symbol">packet-2</span> <span class="mdzsyn-symbol">pk</span> <span class="mdzsyn-symbol">sk</span>)</code></pre><p>Generate a session key on the initiating peer in the KK variant key exchange. state is the jhydro/kx-state from step 1, packet-2 is the packet from step 2, and pk and sk are the local client's public and secret keys. Returns a session keypair, which is a struct of two entries, :rx and :tx.</p></div><div class="docstring"><div class="binding-wrap"><span class="binding"><a id="kx/n-packet-1-bytes">kx/n-packet-1-bytes</a></span><span class="binding-type">number <code class="binding-realval">32</code></span></div><p>Number of bytes in the first packet sent in the N variant key exchange.</p></div><div class="docstring"><div class="binding-wrap"><span class="binding"><a id="kx/n1">kx/n1</a></span><span class="binding-type">cfunction</span></div><pre class="mendoza-codeblock"><code data-language="janet">(<span class="mdzsyn-symbol">kx/n1</span> <span class="mdzsyn-symbol">packet-buf</span> <span class="mdzsyn-symbol">psk</span> <span class="mdzsyn-symbol">peer-pk</span>)</code></pre><p>Create a session key and generate a packet on the client as the first step in the N variant key exchange. Also take a pre-shared key, and the peer's public key. Returns a session key as a struct of two entries, :tx and :rx, which are the transmit and receive keys for communicating with the peer.</p></div><div class="docstring"><div class="binding-wrap"><span class="binding"><a id="kx/n2">kx/n2</a></span><span class="binding-type">cfunction</span></div><pre class="mendoza-codeblock"><code data-language="janet">(<span class="mdzsyn-symbol">kx/n2</span> <span class="mdzsyn-symbol">packet1</span> <span class="mdzsyn-symbol">psk</span> <span class="mdzsyn-symbol">pk</span> <span class="mdzsyn-symbol">sk</span>)</code></pre><p>Create a session key as the second step in the N variant key exchange on the server. packet1 is what kx/n1 put into a buffer (packet-buf), psk is a pre-shared key, pk is the server's public key, and sk is the server's secret key. Returns a session keypair that is a mirror of what is on the client, but :tx and :rx are swapped.</p></div><div class="docstring"><div class="binding-wrap"><span class="binding"><a id="kx/psk-bytes">kx/psk-bytes</a></span><span class="binding-type">number <code class="binding-realval">32</code></span></div><p>Number of bytes in a pre-shared key for key exchange.</p></div><div class="docstring"><div class="binding-wrap"><span class="binding"><a id="kx/public-key-bytes">kx/public-key-bytes</a></span><span class="binding-type">number <code class="binding-realval">32</code></span></div><p>Number of bytes in a public key intended for key exchange.</p></div><div class="docstring"><div class="binding-wrap"><span class="binding"><a id="kx/secret-key-bytes">kx/secret-key-bytes</a></span><span class="binding-type">number <code class="binding-realval">32</code></span></div><p>Number of bytes in a secret key intended for key exchange.</p></div><div class="docstring"><div class="binding-wrap"><span class="binding"><a id="kx/session-key-bytes">kx/session-key-bytes</a></span><span class="binding-type">number <code class="binding-realval">32</code></span></div><p>Number of bytes in a session key (tx or rx key). These keys are used to encrypt and decrypt messages between two peers.</p></div><div class="docstring"><div class="binding-wrap"><span class="binding"><a id="kx/xx-packet-1-bytes">kx/xx-packet-1-bytes</a></span><span class="binding-type">number <code class="binding-realval">32</code></span></div><p>Number of bytes in the first packet sent in the XX variant key exchange.</p></div><div class="docstring"><div class="binding-wrap"><span class="binding"><a id="kx/xx-packet-2-bytes">kx/xx-packet-2-bytes</a></span><span class="binding-type">number <code class="binding-realval">80</code></span></div><p>Number of bytes in the second packet sent in the XX variant key exchange.</p></div><div class="docstring"><div class="binding-wrap"><span class="binding"><a id="kx/xx-packet-3-bytes">kx/xx-packet-3-bytes</a></span><span class="binding-type">number <code class="binding-realval">48</code></span></div><p>Number of bytes in the third packet sent in the XX variant key exchange.</p></div><div class="docstring"><div class="binding-wrap"><span class="binding"><a id="kx/xx1">kx/xx1</a></span><span class="binding-type">cfunction</span></div><pre class="mendoza-codeblock"><code data-language="janet">(<span class="mdzsyn-symbol">kx/xx1</span> <span class="mdzsyn-symbol">packet-1</span> <span class="mdzsyn-symbol">psk</span>)</code></pre><p>First step in XX variant key exchange. Takes in a packet buffer and pre-shared key, and generates the first packet. Also returns a jhydro/kx-state for use in future steps.</p></div><div class="docstring"><div class="binding-wrap"><span class="binding"><a id="kx/xx2">kx/xx2</a></span><span class="binding-type">cfunction</span></div><pre class="mendoza-codeblock"><code data-language="janet">(<span class="mdzsyn-symbol">kx/xx2</span> <span class="mdzsyn-symbol">packet-2</span> <span class="mdzsyn-symbol">packet-1</span> <span class="mdzsyn-symbol">psk</span> <span class="mdzsyn-symbol">pk</span> <span class="mdzsyn-symbol">sk</span>)</code></pre><p>Second step in XX variant key exchange. Takes a buffer for writing packet number 2 too, packet 1, a pre-shared key, and the local public key and secret key. Writes the second packet to packet-2, and returns a jhydro/kx-state.</p></div><div class="docstring"><div class="binding-wrap"><span class="binding"><a id="kx/xx3">kx/xx3</a></span><span class="binding-type">cfunction</span></div><pre class="mendoza-codeblock"><code data-language="janet">(<span class="mdzsyn-symbol">kx/xx3</span> <span class="mdzsyn-symbol">state</span> <span class="mdzsyn-symbol">packet-3</span> <span class="mdzsyn-symbol">packet-2</span> <span class="mdzsyn-symbol">psk</span> <span class="mdzsyn-symbol">pk</span> <span class="mdzsyn-symbol">sk</span> <span class="mdzsyn-symbol">&amp;opt</span> <span class="mdzsyn-symbol">peer-pk</span>)</code></pre><p>Third step in XX variant key exchange. Takes the state returned from kx/xx1, a buffer packet-3 to write the final packet into, the packet packet-2 send from the other peer, a pre-shared key psk, and the public and secret keys of the local machine. Optionally takes a buffer to write the remote peer's public key into, so you can reject connections if they do not match the expected public key. Returns a session keypair, which is a struct with two entries, :rx and :tx.</p></div><div class="docstring"><div class="binding-wrap"><span class="binding"><a id="kx/xx4">kx/xx4</a></span><span class="binding-type">cfunction</span></div><pre class="mendoza-codeblock"><code data-language="janet">(<span class="mdzsyn-symbol">kx/xx4</span> <span class="mdzsyn-symbol">state</span> <span class="mdzsyn-symbol">packet-3</span> <span class="mdzsyn-symbol">psk</span> <span class="mdzsyn-symbol">&amp;opt</span> <span class="mdzsyn-symbol">peer-pk</span>)</code></pre><p>Fourth and final step in the XX key exchange variant. Takes the state returned from kx/xx2, the packet received from kx/xx3, and a pre-shared key psk. Optionally takes a buffer peer-pk, which will have the remote peer's public key written appended to it. Returns a session keypair, which contains :tx and :rx entires.</p></div>
        <div class="prevnext-bar">
          <span class="prev"><a href="kdf.html"><span class="prevnext-text">Key Derivation</span></a></span>
          <span class="next"><a href="pwhash.html"><span class="prevnext-text">Password Hashing</span></a></span>
        </div>
      </div>
    </div>
    <script charset="utf-8">
      function toggleToc() {
        var toggler = document.getElementById('toc-toggle');
        var wrapper = document.querySelector('.toc');
        wrapper.classList.toggle('toc-hidden');
        toggler.classList.toggle('open');
        window.localStorage.setItem('show-toc', toggler.classList.contains('open'));
      }
      function addTocToggle() {
        var el = document.getElementById('toc-toggle');
        el.addEventListener('click', toggleToc);
      }
      window.addEventListener('DOMContentLoaded', addTocToggle);
      if (window.localStorage.getItem('show-toc') === 'true') {
        toggleToc()
      }
    </script>
    <footer>
      <div class="content-wrapper">
        Copyright &copy; Calvin Rose 2019
      </div>
    </footer>
  </body>
</html>
